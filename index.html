<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settlement Calculator</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 16px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.4em;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .section {
            padding: 20px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            background: #3498db;
            color: white;
            padding: 12px 15px;
            margin: -20px -15px 20px -15px;
            font-weight: 700;
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .case-section .section-title {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }

        .negotiation-section {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        }

        .negotiation-section .section-title {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .analysis-section {
            background: linear-gradient(135deg, #f0f8ff 0%, #e3f2fd 100%);
        }

        .analysis-section .section-title {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .input-row label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
        }

        .input-row input {
            width: 120px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: right;
            font-size: 16px;
            font-weight: 700;
            background: white;
        }

        .input-row input[type="text"]#caseName {
            text-align: left;
            width: 200px;
        }

        .input-row input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
        }

        .calculated-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border-radius: 10px;
            border-left: 5px solid #27ae60;
        }

        .calculated-value {
            width: 120px;
            padding: 12px;
            background: white;
            border: 2px solid #27ae60;
            border-radius: 8px;
            text-align: right;
            font-weight: 700;
            color: #27ae60;
            font-size: 16px;
        }

        .analysis-section .calculated-row {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left-color: #2980b9;
        }

        .analysis-section .calculated-value {
            border-color: #2980b9;
            color: #2980b9;
        }

        .formula-hint {
            font-size: 0.7em;
            color: #666;
            font-family: monospace;
            margin-top: 4px;
            opacity: 0.8;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            font-size: 1.1em;
            transition: all 0.2s ease;
        }

        .save-btn {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        .clear-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .btn:active {
            transform: scale(0.98);
        }

        @media (max-width: 400px) {
            .input-row,
            .calculated-row {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 10px;
            }
            
            .input-row input,
            .calculated-value {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Settlement Calculator</h1>
            <p>Professional Mobile App</p>
        </div>

        <!-- Case Information -->
        <div class="section case-section">
            <div class="section-title">
                üìÅ Case Information
            </div>
            
            <div class="input-row">
                <label for="caseName">Case Name</label>
                <input type="text" id="caseName" placeholder="Enter case name">
            </div>
        </div>

        <!-- Primary Settlement Data -->
        <div class="section">
            <div class="section-title">
                üí∞ Primary Settlement Data
            </div>
            
            <div class="input-row">
                <label for="settlement">Settlement</label>
                <input type="text" id="settlement" placeholder="$0">
            </div>
            
            <div class="input-row">
                <label for="expenses">Expenses</label>
                <input type="text" id="expenses" placeholder="$0">
            </div>
            
            <div class="input-row">
                <label for="balances">Balances</label>
                <input type="text" id="balances" placeholder="$0">
            </div>
            
            <div class="input-row">
                <label for="subrogation">Subrogation</label>
                <input type="text" id="subrogation" placeholder="$0">
            </div>
            
            <div class="calculated-row">
                <label>
                    Available
                    <div class="formula-hint">Settlement - Expenses - Balances - Subrogation</div>
                </label>
                <div class="calculated-value" id="available">$0</div>
            </div>
        </div>

        <!-- Negotiation Analysis -->
        <div class="section negotiation-section">
            <div class="section-title">
                ü§ù Negotiation Analysis
            </div>
            
            <div class="input-row">
                <label for="demand">Demand</label>
                <input type="text" id="demand" placeholder="$0">
            </div>
            
            <div class="input-row">
                <label for="offer">Offer</label>
                <input type="text" id="offer" placeholder="$0">
            </div>
            
            <div class="calculated-row">
                <label>
                    Midpoint
                    <div class="formula-hint">Demand - ((Demand - Offer) √∑ 2)</div>
                </label>
                <div class="calculated-value" id="midpoint">$0</div>
            </div>
        </div>

        <!-- Provider & Fee Analysis -->
        <div class="section analysis-section">
            <div class="section-title">
                üè• Provider & Fee Analysis
            </div>
            
            <div class="input-row">
                <label for="provider">Provider</label>
                <input type="text" id="provider" placeholder="$0">
            </div>
            
            <div class="calculated-row">
                <label>
                    Proposed
                    <div class="formula-hint">(Available √∑ (Settlement √ó 0.8 + Provider)) √ó Provider</div>
                </label>
                <div class="calculated-value" id="proposed">$0</div>
            </div>
            
            <div class="input-row">
                <label for="loan">Loan</label>
                <input type="text" id="loan" placeholder="$0">
            </div>
            
            <div class="calculated-row">
                <label>
                    Split
                    <div class="formula-hint">(Available - Proposed) √∑ 2 - Loan</div>
                </label>
                <div class="calculated-value" id="split">$0</div>
            </div>
        </div>

        <!-- Fee Structure Analysis -->
        <div class="section">
            <div class="section-title">
                üìà Fee Structure Analysis
            </div>
            
            <div class="calculated-row">
                <label>
                    Fee Percentage
                    <div class="formula-hint">Split √∑ Settlement √ó 100</div>
                </label>
                <div class="calculated-value" id="feePercent">0%</div>
            </div>
            
            <div class="calculated-row">
                <label>
                    Net @ 33%
                    <div class="formula-hint">Settlement - 33% Fee - Expenses - Balances - Subrogation - Proposed - Loan</div>
                </label>
                <div class="calculated-value" id="netAt33">$0</div>
            </div>
            
            <div class="calculated-row">
                <label>
                    Net @ 40%
                    <div class="formula-hint">Settlement - 40% Fee - Expenses - Balances - Subrogation - Proposed - Loan</div>
                </label>
                <div class="calculated-value" id="netAt40">$0</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="section">
            <button class="btn save-btn" onclick="saveData()">üíæ Save Calculation</button>
            <button class="btn clear-btn" onclick="clearAll()">üóëÔ∏è Clear All Values</button>
        </div>
    </div>

    <script>
        // Helper function to parse currency input
        function parseValue(str) {
            if (!str) return 0;
            return parseFloat(str.toString().replace(/[$,]/g, '')) || 0;
        }

        // Helper function to format currency
        function formatCurrency(num) {
            if (num === 0) return '$0';
            return '$' + Math.round(num).toLocaleString();
        }

        // Helper function to format percentage
        function formatPercent(num) {
            if (num === 0) return '0%';
            return num.toFixed(1) + '%';
        }

        // Format input as user types
        function formatInput(input) {
            let value = input.value.replace(/[^0-9.]/g, '');
            if (value && !isNaN(value)) {
                let num = parseFloat(value);
                input.value = '$' + num.toLocaleString();
            }
        }

        // Main calculation function
        function calculate() {
            console.log('Calculating...'); // Debug log
            
            // Get values from inputs
            const settlement = parseValue(document.getElementById('settlement').value);
            const expenses = parseValue(document.getElementById('expenses').value);
            const balances = parseValue(document.getElementById('balances').value);
            const subrogation = parseValue(document.getElementById('subrogation').value);
            const demand = parseValue(document.getElementById('demand').value);
            const offer = parseValue(document.getElementById('offer').value);
            const provider = parseValue(document.getElementById('provider').value);
            const loan = parseValue(document.getElementById('loan').value);

            console.log('Values:', {settlement, expenses, balances, subrogation, demand, offer, provider, loan}); // Debug log

            // Calculate derived values
            const available = settlement - expenses - balances - subrogation;
            const midpoint = demand > 0 && offer >= 0 ? demand - ((demand - offer) / 2) : 0;
            
            // Provider analysis
            const denominator = (settlement * 0.4 * 2) + provider;
            const proposed = denominator > 0 ? (available / denominator) * provider : 0;
            const split = (available - proposed) / 2 - loan;
            
            // Fee analysis - CORRECTED FORMULAS
            const feePercent = settlement > 0 ? (split / settlement) * 100 : 0;
            
            // Net @ 33% = Settlement - 33% fee - Expenses - Balances - Subrogation - Proposed - Loan
            const netAt33 = settlement - (settlement * 0.33) - expenses - balances - subrogation - proposed - loan;
            
            // Net @ 40% = Settlement - 40% fee - Expenses - Balances - Subrogation - Proposed - Loan  
            const netAt40 = settlement - (settlement * 0.40) - expenses - balances - subrogation - proposed - loan;

            console.log('Calculated:', {available, midpoint, proposed, split, feePercent, netAt33, netAt40}); // Debug log

            // Update display
            document.getElementById('available').textContent = formatCurrency(available);
            document.getElementById('midpoint').textContent = formatCurrency(midpoint);
            document.getElementById('proposed').textContent = formatCurrency(proposed);
            document.getElementById('split').textContent = formatCurrency(split);
            document.getElementById('feePercent').textContent = formatPercent(feePercent);
            document.getElementById('netAt33').textContent = formatCurrency(netAt33);
            document.getElementById('netAt40').textContent = formatCurrency(netAt40);
        }

        // Save function
        function saveData() {
            console.log('Saving data...'); // Debug log
            
            const data = {
                caseName: document.getElementById('caseName').value,
                settlement: document.getElementById('settlement').value,
                expenses: document.getElementById('expenses').value,
                balances: document.getElementById('balances').value,
                subrogation: document.getElementById('subrogation').value,
                demand: document.getElementById('demand').value,
                offer: document.getElementById('offer').value,
                provider: document.getElementById('provider').value,
                loan: document.getElementById('loan').value,
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('settlementData', JSON.stringify(data));
                
                // Show feedback
                const btn = document.querySelector('.save-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Saved!';
                btn.style.background = '#27ae60';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
                
                console.log('Data saved successfully'); // Debug log
            } catch (error) {
                console.error('Save failed:', error);
                alert('Save failed. Please try again.');
            }
        }

        // Clear function
        function clearAll() {
            console.log('Clearing all...'); // Debug log
            
            // Clear all inputs
            document.getElementById('caseName').value = '';
            document.getElementById('settlement').value = '';
            document.getElementById('expenses').value = '';
            document.getElementById('balances').value = '';
            document.getElementById('subrogation').value = '';
            document.getElementById('demand').value = '';
            document.getElementById('offer').value = '';
            document.getElementById('provider').value = '';
            document.getElementById('loan').value = '';
            
            // Clear calculated values
            document.getElementById('available').textContent = '$0';
            document.getElementById('midpoint').textContent = '$0';
            document.getElementById('proposed').textContent = '$0';
            document.getElementById('split').textContent = '$0';
            document.getElementById('feePercent').textContent = '0%';
            document.getElementById('netAt33').textContent = '$0';
            document.getElementById('netAt40').textContent = '$0';
            
            // Show feedback
            const btn = document.querySelector('.clear-btn');
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Cleared!';
            
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1000);
            
            console.log('All cleared'); // Debug log
        }

        // Load saved data
        function loadData() {
            try {
                const saved = localStorage.getItem('settlementData');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // Load values into inputs
                    Object.keys(data).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && key !== 'timestamp') {
                            element.value = data[key];
                        }
                    });
                    
                    // Recalculate
                    calculate();
                    console.log('Data loaded successfully'); // Debug log
                }
            } catch (error) {
                console.error('Load failed:', error);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, setting up events...'); // Debug log
            
            // Add event listeners to all currency inputs
            const currencyInputs = document.querySelectorAll('input[type="text"]:not(#caseName)');
            currencyInputs.forEach(input => {
                // Format on blur
                input.addEventListener('blur', function() {
                    formatInput(this);
                    calculate();
                });
                
                // Calculate on input
                input.addEventListener('input', function() {
                    // Delay calculation slightly to allow user to type
                    setTimeout(() => {
                        calculate();
                    }, 300);
                });
                
                // Select all on focus
                input.addEventListener('focus', function() {
                    this.select();
                });
            });
            
            // Case name input
            document.getElementById('caseName').addEventListener('focus', function() {
                this.select();
            });
            
            // Load saved data
            loadData();
            
            // Initial calculation
            calculate();
            
            console.log('Setup complete'); // Debug log
        });
    </script>
</body>
</html>
