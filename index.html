<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settlement Calculator</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 16px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.4em;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .section {
            padding: 20px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            background: #3498db;
            color: white;
            padding: 12px 15px;
            margin: -20px -15px 20px -15px;
            font-weight: 700;
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .case-section .section-title {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }

        .negotiation-section {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        }

        .negotiation-section .section-title {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .analysis-section {
            background: linear-gradient(135deg, #f0f8ff 0%, #e3f2fd 100%);
        }

        .analysis-section .section-title {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .input-row label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
        }

        .input-row input {
            width: 120px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: right;
            font-size: 16px;
            font-weight: 700;
            background: white;
        }

        .input-row input[type="text"]#caseName {
            text-align: left;
            width: 200px;
        }

        .input-row input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
        }

        .calculated-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border-radius: 10px;
            border-left: 5px solid #27ae60;
        }

        .calculated-value {
            width: 120px;
            padding: 12px;
            background: white;
            border: 2px solid #27ae60;
            border-radius: 8px;
            text-align: right;
            font-weight: 700;
            color: #27ae60;
            font-size: 16px;
        }

        .analysis-section .calculated-row {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left-color: #2980b9;
        }

        .analysis-section .calculated-value {
            border-color: #2980b9;
            color: #2980b9;
        }

        .formula-hint {
            font-size: 0.7em;
            color: #666;
            font-family: monospace;
            margin-top: 4px;
            opacity: 0.8;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            font-size: 1.1em;
            transition: all 0.2s ease;
        }

        .save-btn {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        .clear-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .btn:active {
            transform: scale(0.98);
        }

        @media (max-width: 400px) {
            .input-row,
            .calculated-row {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 10px;
            }
            
            .input-row input,
            .calculated-value {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Settlement Calculator</h1>
            <p>Based on Robert Souder's Excel Formulas</p>
        </div>

        <!-- Case Information -->
        <div class="section case-section">
            <div class="section-title">
                Case Information
            </div>
            
            <div class="input-row">
                <label for="caseName">Case Name</label>
                <input type="text" id="caseName" placeholder="Enter case name">
            </div>
        </div>

        <!-- Primary Settlement Data -->
        <div class="section">
            <div class="section-title">
                Primary Settlement Data
            </div>
            
            <div class="input-row">
                <label for="settlement">Settlement (A2)</label>
                <input type="text" id="settlement" placeholder="$0">
            </div>
            
            <div class="input-row">
                <label for="expenses">Expenses (B2)</label>
                <input type="text" id="expenses" placeholder="$0">
            </div>
            
            <div class="input-row">
                <label for="balances">Balances (C2)</label>
                <input type="text" id="balances" placeholder="$0">
            </div>
            
            <div class="input-row">
                <label for="subrogation">Subrogation (D2)</label>
                <input type="text" id="subrogation" placeholder="$0">
            </div>
            
            <div class="calculated-row">
                <label>
                    Available (E2)
                    <div class="formula-hint">A2-B2-C2-D2</div>
                </label>
                <div class="calculated-value" id="available">$0</div>
            </div>
        </div>

        <!-- Negotiation Analysis -->
        <div class="section negotiation-section">
            <div class="section-title">
                Negotiation Analysis
            </div>
            
            <div class="input-row">
                <label for="demand">Demand (A4)</label>
                <input type="text" id="demand" placeholder="$0">
            </div>
            
            <div class="input-row">
                <label for="offer">Offer (B4)</label>
                <input type="text" id="offer" placeholder="$0">
            </div>
            
            <div class="calculated-row">
                <label>
                    Midpoint (C4)
                    <div class="formula-hint">A4-((A4-B4)/2)</div>
                </label>
                <div class="calculated-value" id="midpoint">$0</div>
            </div>
        </div>

        <!-- Provider & Fee Analysis -->
        <div class="section analysis-section">
            <div class="section-title">
                Provider & Fee Analysis
            </div>
            
            <div class="input-row">
                <label for="provider">Provider (A6)</label>
                <input type="text" id="provider" placeholder="$0">
            </div>
            
            <div class="calculated-row">
                <label>
                    Proposed (B6)
                    <div class="formula-hint">(E2/(A2*0.4*2+A6))*A6</div>
                </label>
                <div class="calculated-value" id="proposed">$0</div>
            </div>
            
            <div class="input-row">
                <label for="loan">Loan (C6)</label>
                <input type="text" id="loan" placeholder="$0">
            </div>
            
            <div class="calculated-row">
                <label>
                    Split (D6)
                    <div class="formula-hint">(A2-B2-C2-D2-B6)/2-C6</div>
                </label>
                <div class="calculated-value" id="split">$0</div>
            </div>
        </div>

        <!-- Fee Structure Analysis -->
        <div class="section">
            <div class="section-title">
                Fee Structure Analysis
            </div>
            
            <div class="calculated-row">
                <label>
                    Fee Percentage (B8)
                    <div class="formula-hint">D6/A2</div>
                </label>
                <div class="calculated-value" id="feePercent">0%</div>
            </div>
            
            <div class="calculated-row">
                <label>
                    Net @ 33% (C8)
                    <div class="formula-hint">A2-B2-C2-D2-B6-D4-C6</div>
                </label>
                <div class="calculated-value" id="netAt33">$0</div>
            </div>
            
            <div class="calculated-row">
                <label>
                    Net @ 40% (D8)
                    <div class="formula-hint">A2-B2-C2-D2-B6-E4-C6</div>
                </label>
                <div class="calculated-value" id="netAt40">$0</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="section">
            <button class="btn save-btn" onclick="saveData()">Save Calculation</button>
            <button class="btn clear-btn" onclick="clearAll()">Clear All Values</button>
        </div>
    </div>

    <script>
        // Helper function to parse currency input
        function parseValue(str) {
            if (!str) return 0;
            return parseFloat(str.toString().replace(/[$,]/g, '')) || 0;
        }

        // Helper function to format currency
        function formatCurrency(num) {
            if (num === 0) return '$0';
            return '$' + Math.round(num).toLocaleString();
        }

        // Helper function to format percentage
        function formatPercent(num) {
            if (num === 0) return '0%';
            return num.toFixed(2) + '%';
        }

        // Format input as user types
        function formatInput(input) {
            let value = input.value.replace(/[^0-9.]/g, '');
            if (value && !isNaN(value)) {
                let num = parseFloat(value);
                input.value = '$' + num.toLocaleString();
            }
        }

        // Main calculation function using EXACT Souder formulas
        function calculate() {
            console.log('Calculating with Souder formulas...'); 
            
            // Get values from inputs (A2, B2, C2, D2, A4, B4, A6, C6)
            const A2 = parseValue(document.getElementById('settlement').value);   // Settlement
            const B2 = parseValue(document.getElementById('expenses').value);     // Expenses
            const C2 = parseValue(document.getElementById('balances').value);     // Balances
            const D2 = parseValue(document.getElementById('subrogation').value);  // Subrogation (now editable)
            const A4 = parseValue(document.getElementById('demand').value);       // Demand
            const B4 = parseValue(document.getElementById('offer').value);        // Offer
            const A6 = parseValue(document.getElementById('provider').value);     // Provider
            const C6 = parseValue(document.getElementById('loan').value);         // Loan

            console.log('Input values:', {A2, B2, C2, D2, A4, B4, A6, C6});

            // EXACT SOUDER FORMULAS:
            // E2: Available = A2-B2-C2-D2
            const E2 = A2 - B2 - C2 - D2;
            
            // C4: Midpoint = A4-((A4-B4)/2)
            const C4 = A4 > 0 && B4 >= 0 ? A4 - ((A4 - B4) / 2) : 0;
            
            // D4: 33% of settlement = A2/3
            const D4 = A2 / 3;
            
            // E4: 40% of settlement = A2*0.4
            const E4 = A2 * 0.4;
            
            // B6: Proposed = (E2/(A2*0.4*2+A6))*A6
            const B6 = (A2 > 0 && (A2 * 0.4 * 2 + A6) > 0) ? (E2 / (A2 * 0.4 * 2 + A6)) * A6 : 0;
            
            // D6: Split = (A2-B2-C2-D2-B6)/2-C6
            const D6 = (A2 - B2 - C2 - D2 - B6) / 2 - C6;
            
            // B8: Fee % = D6/A2
            const B8 = A2 > 0 ? (D6 / A2) * 100 : 0;
            
            // C8: Net @ 33% = A2-B2-C2-D2-B6-D4-C6
            const C8 = A2 - B2 - C2 - D2 - B6 - D4 - C6;
            
            // D8: Net @ 40% = A2-B2-C2-D2-B6-E4-C6
            const D8 = A2 - B2 - C2 - D2 - B6 - E4 - C6;

            console.log('Calculated values:', {E2, C4, D4, E4, B6, D6, B8, C8, D8});

            // Update display with exact Souder results
            document.getElementById('available').textContent = formatCurrency(E2);
            document.getElementById('midpoint').textContent = formatCurrency(C4);
            document.getElementById('proposed').textContent = formatCurrency(B6);
            document.getElementById('split').textContent = formatCurrency(D6);
            document.getElementById('feePercent').textContent = formatPercent(B8);
            document.getElementById('netAt33').textContent = formatCurrency(C8);
            document.getElementById('netAt40').textContent = formatCurrency(D8);
        }

        // Save function
        function saveData() {
            const data = {
                caseName: document.getElementById('caseName').value,
                settlement: document.getElementById('settlement').value,
                expenses: document.getElementById('expenses').value,
                balances: document.getElementById('balances').value,
                demand: document.getElementById('demand').value,
                offer: document.getElementById('offer').value,
                provider: document.getElementById('provider').value,
                loan: document.getElementById('loan').value,
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('settlementData', JSON.stringify(data));
                
                const btn = document.querySelector('.save-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Saved!';
                btn.style.background = '#27ae60';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
                
                console.log('Data saved successfully');
            } catch (error) {
                console.error('Save failed:', error);
                alert('Save failed. Please try again.');
            }
        }

        // Clear function
        function clearAll() {
            document.getElementById('caseName').value = '';
            document.getElementById('settlement').value = '';
            document.getElementById('expenses').value = '';
            document.getElementById('balances').value = '';
            document.getElementById('subrogation').value = '';
            document.getElementById('demand').value = '';
            document.getElementById('offer').value = '';
            document.getElementById('provider').value = '';
            document.getElementById('loan').value = '';
            
            document.getElementById('available').textContent = '$0';
            document.getElementById('midpoint').textContent = '$0';
            document.getElementById('proposed').textContent = '$0';
            document.getElementById('split').textContent = '$0';
            document.getElementById('feePercent').textContent = '0%';
            document.getElementById('netAt33').textContent = '$0';
            document.getElementById('netAt40').textContent = '$0';
            
            const btn = document.querySelector('.clear-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Cleared!';
            
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1000);
        }

        // Load saved data
        function loadData() {
            try {
                const saved = localStorage.getItem('settlementData');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    Object.keys(data).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && key !== 'timestamp') {
                            element.value = data[key];
                        }
                    });
                    
                    calculate();
                    console.log('Data loaded successfully');
                }
            } catch (error) {
                console.error('Load failed:', error);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, setting up events...');
            
            const currencyInputs = document.querySelectorAll('input[type="text"]:not(#caseName)');
            currencyInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    formatInput(this);
                    calculate();
                });
                
                input.addEventListener('input', function() {
                    setTimeout(() => {
                        calculate();
                    }, 300);
                });
                
                input.addEventListener('focus', function() {
                    this.select();
                });
            });
            
            document.getElementById('caseName').addEventListener('focus', function() {
                this.select();
            });
            
            loadData();
            calculate();
            
            console.log('Setup complete');
        });
    </script>
</body>
</html>
